---
title: "Multiple imputation"
author: "Carolien C.H.M. Maas"
date: "December 2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Describe data

### Load packages, functions, and data 
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# erase memory
rm(list = ls(all.names = TRUE))

# for reproducibility
set.seed(100)

# load libraries
library(mice)
library(survival)
library(survminer)
library(stats)
library(prodlim)
library(utils)
source("Z:/Project Melanoom/PaperMelanoma/Code/PaperMelanomaFunctions.R")
```

```{r, eval=TRUE}
prepare.data <- function(type){
  # Load imputed data set 
  load(paste0("Z:/Project Melanoom/PaperMelanoma/Data/", type, "/", type, ".data.RData"))
  imputed.data <- eval(parse(text=paste0("imputed.", type, ".data")))
  last.imputed.data.set <- mice::complete(imputed.data, m)
  
  assign(paste0("S.Rec.", type), survival::Surv(exp(last.imputed.data.set$logRec.time), last.imputed.data.set$Recurrence=="recurred"))
  assign(paste0("S.MSM.", type), survival::Surv(exp(last.imputed.data.set$logFU.time), last.imputed.data.set$MSM=="Death by melanoma"))
  
  assign(paste0("imputed.", type, ".data"), imputed.data)
  assign(paste0("last.imputed.", type, ".data.set"), last.imputed.data.set)
  
  save(list=c(paste0("dd.", type), "m", 
              paste0(type, ".data.to.be.imputed"), 
              paste0("imputed.", type, ".data"), 
              paste0("last.imputed.", type, ".data.set"), 
              paste0("S.Rec.", type), 
              paste0("S.MSM.", type)),
       file=paste0("Z:/Project Melanoom/PaperMelanoma/Data/", type, "/", type, ".data.Rdata"), compress=TRUE)
}
prepare.data(type="training")
prepare.data(type="validation")
```

### Kaplan-Meier plots
```{r, eval=TRUE}
load(paste0("Z:/Project Melanoom/PaperMelanoma/Data/training/training.data.RData"))
survminer::ggsurvplot(survival::survfit(S.Rec.training ~ Center, data=last.imputed.training.data.set), conf.int=TRUE, risk.table=TRUE)
survminer::ggsurvplot(survival::survfit(S.MSM.training ~ Center, data=last.imputed.training.data.set), conf.int=TRUE, risk.table=TRUE)
load(paste0("Z:/Project Melanoom/PaperMelanoma/Data/validation/validation.data.RData"))
survminer::ggsurvplot(survival::survfit(S.Rec.validation ~ 1, data=last.imputed.validation.data.set), conf.int=TRUE, risk.table=TRUE)
survminer::ggsurvplot(survival::survfit(S.MSM.validation ~ 1, data=last.imputed.validation.data.set), conf.int=TRUE, risk.table=TRUE)
```

# Median time to recurrence and follow-up time
```{r, eval=TRUE}
median.time <- function(data=NA, type=NA){
  # time in total
  if (type=="Rec"){
    median.time.total <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logRec.time), Recurrence=="recurred")~1, data=data[data$Center!="Australia",], reverse=TRUE))
    median.time <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logRec.time), Recurrence=="recurred")~Center, data=data, reverse=TRUE))
  } else if (type=="FU"){
    median.time.total <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logFU.time), MSM=="Death by melanoma")~1, data=data[data$Center!="Australia",], reverse=TRUE))
    median.time <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logFU.time), MSM=="Death by melanoma")~Center, data=data, reverse=TRUE))
  }
  
  # save in tab.time
  tab.time <- c("Total Development", paste(sprintf("%.2f", median.time.total$quantiles.survival[3, "quantile"]),
                   paste0("[", sprintf("%.2f", median.time.total$quantiles.survival[3, "lower"]), "; ",
                          sprintf("%.2f", median.time.total$quantiles.survival[3, "upper"]), "]")))
  
  # time per center
  for (center in c("Amsterdam", "Berlin", "Rotterdam", "Warsaw", "Australia")){
    med.table <- eval(parse(text=paste0("median.time$`Center=", center, "`")))
    med <- med.table[3,"quantile"]
    lower <- med.table[3,"lower"]
    upper <- med.table[3,"upper"]
    tab.time <- rbind(tab.time, c(center, paste(sprintf("%.2f", med), paste0("[", sprintf("%.2f", lower), "; ", sprintf("%.2f", upper), "]"))))
  }
  
  return(tab.time)
}
med.Rec <- median.time(data=rbind(training.data.to.be.imputed[, c("logRec.time", "Recurrence", "Center")], 
                       validation.data.to.be.imputed[, c("logRec.time", "Recurrence", "Center")]), type="Rec")
med.FU <- median.time(data=rbind(training.data.to.be.imputed[, c("logFU.time", "MSM", "Center")], 
                       validation.data.to.be.imputed[, c("logFU.time", "MSM", "Center")]), type="FU")
# save to .txt
write.table(cbind(c("Recurrence time", "Follow-up time"), 
                  rbind(c(med.Rec[, -1]), c(med.FU[,-1]))),
              file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/med.table.txt"),
              row.names=FALSE, sep=",")
```

# Kaplan-Meier estimates of recurrence and MSM at 5 years
```{r, eval=TRUE}
Rec.MSM.table <- function(horizon=5, type=NULL, data.to.be.imputed=NULL){
  # all patients, Recurrence
  S.Rec <- eval(parse(text=paste0("S.Rec.", type)))
  SF.Rec.all <- survival::survfit(S.Rec~1, data=data.to.be.imputed)
  Rec.all <- 100*(1-SF.Rec.all$surv[SF.Rec.all$time==max(SF.Rec.all$time[SF.Rec.all$time<=horizon])])
  n.Rec.all <- sum(SF.Rec.all$n.event[SF.Rec.all$time<=horizon])
  
  # only negative patients, Recurrence
  SF.Rec.neg <-survival::survfit(S.Rec[data.to.be.imputed$SNstatus=="Negative"]~1, data=data.to.be.imputed)
  Rec.neg <- 100*(1-SF.Rec.neg$surv[SF.Rec.neg$time==max(SF.Rec.neg$time[SF.Rec.neg$time<=horizon])])
  n.Rec.neg <- sum(SF.Rec.neg$n.event[SF.Rec.neg$time<=horizon])
    
  # only positive patients, Recurrence
  SF.Rec.pos <- survival::survfit(S.Rec[data.to.be.imputed$SNstatus=="Positive"]~1, data=data.to.be.imputed)
  Rec.pos <- 100*(1-SF.Rec.pos$surv[SF.Rec.pos$time==max(SF.Rec.pos$time[SF.Rec.pos$time<=horizon])])
  n.Rec.pos <- sum(SF.Rec.pos$n.event[SF.Rec.pos$time<=horizon])
  
  # all patients, MSM
  S.MSM <- eval(parse(text=paste0("S.MSM.", type)))
  SF.MSM.all <- survival::survfit(S.MSM~1, data=data.to.be.imputed)
  MSM.all <- 100*(1-SF.MSM.all$surv[SF.MSM.all$time==max(SF.MSM.all$time[SF.MSM.all$time<=horizon])])
  n.MSM.all <- sum(SF.MSM.all$n.event[SF.MSM.all$time<=horizon])
  
  # negative patients, MSM
  SF.MSM.neg <- survival::survfit(S.MSM[data.to.be.imputed$SNstatus=="Negative"]~1, data=data.to.be.imputed)
  MSM.neg <- 100*(1-SF.MSM.neg$surv[SF.MSM.neg$time==max(SF.MSM.neg$time[SF.MSM.neg$time<=horizon])])
  n.MSM.neg <- sum(SF.MSM.neg$n.event[SF.MSM.neg$time<=horizon])
  
  # positive patients, MSM
  SF.MSM.pos <- survival::survfit(S.MSM[data.to.be.imputed$SNstatus=="Positive"]~1, data=data.to.be.imputed)
  MSM.pos <- 100*(1-SF.MSM.pos$surv[SF.MSM.pos$time==max(SF.MSM.pos$time[SF.MSM.pos$time<=horizon])])
  n.MSM.pos <- sum(SF.MSM.pos$n.event[SF.MSM.pos$time<=horizon])
  
  # merge in one table
  Rec.MSM.table <- data.frame(n=c(nrow(data.to.be.imputed),
                                  sum(data.to.be.imputed$SNstatus=="Negative"),
                                  sum(data.to.be.imputed$SNstatus=="Positive")),
                              e1=rep("", 3),
                              n.Rec=c(n.Rec.all, n.Rec.pos, n.Rec.neg),
                              n.MSM=c(n.MSM.all, n.MSM.pos, n.MSM.neg),
                              e2=rep("", 3),
                              Rec=sprintf("%.1f", c(Rec.all, Rec.neg, Rec.pos)),
                              MSM=sprintf("%.1f", c(MSM.all, MSM.neg, MSM.pos)))
  row.names(Rec.MSM.table) <- c("All", "Negative", "Positive")
  
  return(Rec.MSM.table)
}
horizon <- 5
train.table <- Rec.MSM.table(horizon=horizon, type="training", data.to.be.imputed=training.data.to.be.imputed)
val.table <- Rec.MSM.table(horizon=horizon, type="validation", data.to.be.imputed=validation.data.to.be.imputed)

utils::write.table(cbind(train.table, rep("", 3), val.table),
                   file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Rec.MSM.table.txt"),
                   row.names=TRUE, sep=",")
```

# Restrict survival at 5 years
```{r, eval=TRUE}
for (type in c("training",  "validation")){
  load(paste0("Z:/Project Melanoom/PaperMelanoma/Data/", type, "/", type, ".data.Rdata"))
  for (outcome in c("Rec", "MSM")){
    S <- eval(parse(text=paste0("S.", outcome, ".", type)))
    cat("Number of patients with follow-up for", outcome, "after 5 years:", sum(S[, 1]>5), "in", type, " data \n")
    S.5 <- S
    S.5[S[,1]>5, 1] <- 5 # set time to 5
    S.5[S[,1]>5, 2] <- 0 # set censoring
    
    assign(paste0("S.", outcome, ".5.", type), S.5)
  }
  save(list=c(paste0("dd.", type), "m", "horizon", 
              paste0(type, ".data.to.be.imputed"),
              paste0("imputed.", type, ".data"), 
              paste0("last.imputed.", type, ".data.set"),
              paste0("S.Rec.", type), 
              paste0("S.MSM.", type),
              paste0("S.Rec.5.", type), 
              paste0("S.MSM.5.", type)),
     file=paste0("Z:/Project Melanoom/PaperMelanoma/Data/", type, "/", type, ".data.Rdata"), compress=TRUE)
}
```
