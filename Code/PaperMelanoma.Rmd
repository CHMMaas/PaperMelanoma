---
title: "PaperMelanoma"
author: "Carolien C.H.M. Maas"
date: "3-6-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Development and validation of a clinial prediction model to predict recurrence and disease-specific mortality in patients with melanoma after sentinel lymph node biopsy

This file includes the code and results for the above mentioned paper.

# Data preparation
### Load packages, functions, and data 
```{r, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
# load libraries
library(foreign)
library(mice)
library(survminer)
library(prodlim)
library(rms)
library(Hmisc)
library(png)
set.seed(100)
# import function to create table of missing values
source("Z:/Project Melanoom/PaperMelanoma/Code/table.missing.values.R") 
# import function to plot calibration
source("Z:/Project Melanoom/PaperMelanoma/Code/val_surv_mi_v3.R")
# helper functions for calibration plots
km <- function(sel, S.km, horizon){
  S.km.sel <- S.km[sel,]
  sf <- survfit(S.km.sel~1)
  year1 <- max(sf$time[sf$time<=horizon])
  1-sf$surv[sf$time==year1]
}
km.lower <- function(sel, S.km, horizon){
  S.km.sel <- S.km[sel,]
  sf <- survfit(S.km.sel~1)
  year1 <- max(sf$time[sf$time<=horizon])
  1-sf$lower[sf$time==year1]
}
km.upper <- function(sel, S.km, horizon){
  S.km.sel <- S.km[sel,]
  sf <- survfit(S.km.sel~1)
  year1 <- max(sf$time[sf$time<=horizon])
  1-sf$upper[sf$time==year1]
}
fun.event <- function(lp, h0)
{
  h <- h0*exp(lp)
  p <- 1-exp(-h)
  return(p)
}

# load data file
original.data <- foreign::read.spss(file="Z:/Project Melanoom/PaperMelanoma/Data/Dataset Predictiemodel Stassen.sav",
                                    to.data.frame=TRUE, origin="01-01-1970")

# Select necessary variables
selected.vars <- c("EXCLUSIE", "DatabaseNR", "Center", "Sex", "Age", "DOB",
                   "Ulceration", "Loc_CAT",            # OLD data set: Loc_CAT2
                   "Histology", "Breslow", "Tot_nr_SNs",
                   "nr_SNs_Field_1", "nr_SNs_Field_2", "nr_SNs_Field_3",
                   "Mitosis",                          # needed for AJCC.7.i
                   "SNdate", "Recurrence", "Date_1st_Rec", "Last_FU",
                   "dead", "Status",
                   "SNstatus",                         # distinguish between positive and negative SN patients
                   "Tot_SNs_pos", "Rdamcrit", "Dewar") # additional for positive SN patients
```

### Exclude patients
Exclude when Exclusion = 2: based on duplicates, urogenital melanoma, etc.
Leave the patients included that have EXCLUSIE = 1 and Dbstatus = 8,
even though diagnosis and operation date are very close.
```{r, eval=TRUE}
sel.data <- original.data[original.data$EXCLUSIE!="Exclusion", selected.vars]
cat("Number of patients excluded:", nrow(original.data)-nrow(sel.data), "\n")
```
Omit patient A0523 - no last follow-up date
```{r, eval=TRUE}
sel.data <- sel.data[sel.data$DatabaseNR!="A0523               ",]
```

### Recode
Set Rdamcrit of negative SN patients equal to 0. 11 patients with positive SN have SN tumour burden of exactly 1
```{r, eval=TRUE}
sum(sel.data$Rdamcrit==1&sel.data$SNstatus=="Positive"&!is.na(sel.data$Rdamcrit))
sel.data$Rdamcrit[sel.data$SNstatus=="Negative"] <- 1 # since log(1) = 0
```

Merge single cells with subcap and set Dewar for negative patients to subcap
```{r, eval=TRUE}
sel.data$Dewar[sel.data$Dewar=="single cells"] <- "subcap"
sel.data$Dewar[sel.data$SNstatus=="Negative"] <- "subcap"
```

Merge location other with trunk
```{r, eval=TRUE}
sel.data$Loc_CAT[sel.data$Loc_CAT=="other"] <- "trunk"
```

Merge LMM other with other
```{r, eval=TRUE}
sel.data$Histology[sel.data$Histology=="LMM"] <- "other"
```

Melanoma specific mortality (MSM)
```{r, eval=TRUE}
sel.data$MSM<-1*(sel.data$Status=="DOD")
```

Define multiple fields
```{r, eval=TRUE}
sel.data$multiple.fields <- ifelse(!is.na(sel.data$nr_SNs_Field_2)&sel.data$nr_SNs_Field_2>0,1,0)
```

Create number of negative nodes removed
```{r, eval=TRUE}
sel.data$Tot_SNs_neg <- sel.data$Tot_nr_SNs - sel.data$Tot_SNs_pos
```

Use age at SN instead of age at diagnosis
```{r, eval=TRUE}
sel.data$Age.SN <- floor((sel.data$SNdate-sel.data$DOB)/(24*60*60)/365.25)
```

Define time since diagnosis in years (follow-up time)
```{r, eval=TRUE}
sel.data$FU.time <- (sel.data$Last_FU-sel.data$SNdate)/(24*60*60)/365.25
```

Define recurrence time in years
```{r, eval=TRUE}
sel.data$Rec.time<- (sel.data$Date_1st_Rec-sel.data$SNdate)/(24*60*60)/365.25
```

Omit patients with Rec date before SN date
```{r, eval=TRUE}
old.n <- nrow(sel.data)
sel.data <- sel.data[!(sel.data$Rec.time<0&!is.na(sel.data$Rec.time)),]
cat("Number of patients excluded:", old.n-nrow(sel.data), "\n")
```

Set recurrence time equal to follow-up time for those without recurrence
```{r, eval=TRUE}
sel.data$Rec.time[sel.data$Recurrence=="no recurrence"|is.na(sel.data$SNdate)]<-sel.data$FU.time[sel.data$Recurrence=="no recurrence"|is.na(sel.data$SNdate)]
```

Set Mitosis to Unknown if missing
```{r, eval=TRUE}
sel.data$Mitosis[is.na(sel.data$Mitosis)] <- "Unknown" # mitosis unknown for 80% of patients
```

Replace "Unknown" by NA
```{r, eval=TRUE}
sel.data$Ulceration[sel.data$Ulceration=="unknown"]<-NA
sel.data$Loc_CAT[sel.data$Loc_CAT=="unknown"]<-NA
sel.data$Histology[sel.data$Histology=="unknown"]<-NA
sel.data$Dewar[sel.data$Dewar=="unknown"] <- NA
sel.data$Mitosis[sel.data$Mitosis=="Unknown"] <- NA
```

Delete unused levels
```{r, eval=TRUE}
sel.data <- droplevels(sel.data)
```

# Multiple imputation
```{r, eval=TRUE}
variables.to.be.imputed <- c("Center", "SNstatus", "Sex", "Age.SN", "Ulceration",
                             "Loc_CAT", "Histology", "Breslow", "multiple.fields",
                             "Tot_SNs_neg", "Tot_SNs_pos", "Rdamcrit", "Dewar",
                             "Mitosis",
                             "Recurrence", "dead", "MSM")
data.to.be.imputed <- sel.data[,variables.to.be.imputed]
```
Save distributions of all variables, necessary for Harrell summaries
```{r, eval=TRUE}
dd<-datadist(data.to.be.imputed)
options(datadist='dd')
options(digits=8)
```

Relation between outcome and covariates
```{r, eval=TRUE}
data.to.be.imputed$logRec.time <- log(sel.data$Rec.time+1/365.25)
data.to.be.imputed$logFU.time <- log(sel.data$FU.time+1/365.25)
missings.table(data.to.be.imputed)
save(data.to.be.imputed,file='Z:/Project Melanoom/PaperMelanoma/Data/descr.data.Rdata', compress=TRUE)
```

Number of imputations
```{r, eval=TRUE}
m <- 5
```

Perform multiple imputation
```{r, eval=FALSE}
imputed.data <- mice::mice(data.to.be.imputed, m=m, maxit=5, print=FALSE, seed=500)
print(imputed.data$loggedEvents)
save(imputed.data,file='Z:/Project Melanoom/PaperMelanoma/Data/imputed.data.RData', compress=TRUE)
```

Load imputed data set
```{r, eval=TRUE}
load('Z:/Project Melanoom/PaperMelanoma/Data/imputed.data.RData')
last.imputed.data.set <- mice::complete(imputed.data, m)
summary(last.imputed.data.set)
missings.table(last.imputed.data.set)
```

# Set as survival data
```{r, eval=TRUE}
S.Rec <- survival::Surv(exp(last.imputed.data.set$logRec.time), sel.data$Recurrence=="recurred")
S.MSM <- survival::Surv(exp(last.imputed.data.set$logFU.time), sel.data$MSM)
```

### Kaplan-Meier plots
```{r, eval=TRUE}
center.Rec.KM <- survival::survfit(S.Rec ~ Center, data=sel.data)
survminer::ggsurvplot(center.Rec.KM, conf.int=TRUE, risk.table=TRUE)
center.MSM.KM <- survival::survfit(S.MSM ~ Center, data=sel.data)
survminer::ggsurvplot(center.MSM.KM, conf.int=TRUE, risk.table=TRUE)
```

# Median follow-up time
```{r, eval=TRUE}
median.FU.time.total <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logFU.time), MSM)~1, data=last.imputed.data.set, reverse=TRUE))
tab.FU.time <- c("total", paste(sprintf("%.2f", median.FU.time.total$quantiles.survival[3, "quantile"]),
                 paste0("[", sprintf("%.2f", median.FU.time.total$quantiles.survival[3, "lower"]), "; ",
                        sprintf("%.2f", median.FU.time.total$quantiles.survival[3, "upper"]), "]")))
median.FU.time <- stats::quantile(prodlim::prodlim(prodlim::Hist(exp(logFU.time), MSM)~Center, data=last.imputed.data.set, reverse=TRUE))
for (center in sort(as.character(unique(sel.data$Center)))){
  med.FU.table <- eval(parse(text=paste0("median.FU.time$`Center=", center, "`")))
  med.FU <- med.FU.table[3,"quantile"]
  lower.FU <- med.FU.table[3,"lower"]
  upper.FU <- med.FU.table[3,"upper"]
  tab.FU.time <- rbind(tab.FU.time, c(center, paste(sprintf("%.2f", med.FU), paste0("[", sprintf("%.2f", lower.FU), "; ", sprintf("%.2f", upper.FU), "]"))))
}
write.table(as.data.frame(tab.FU.time),file='Z:/Project Melanoom/PaperMelanoma/Results/med.FU.table.txt',
            row.names=FALSE)
tab.FU.time
```

# Recurrence at 5 years
```{r, eval=TRUE}
Rec.table <- c("Total", sum(sel.data$Recurrence=="recurred"), sprintf("%.1f", sum(sel.data$Recurrence=="recurred")/nrow(sel.data)*100))
Rec.table <- rbind(Rec.table, c("Positive", 
                                sum(sel.data$Recurrence=="recurred"&sel.data$SNstatus=="Positive"),
                                sprintf("%.1f", sum(sel.data$Recurrence=="recurred"&sel.data$SNstatus=="Positive")/sum(sel.data$SNstatus=="Positive")*100)))
Rec.table <- rbind(Rec.table, c("Negative", 
                                sum(sel.data$Recurrence=="recurred"&sel.data$SNstatus=="Negative"),
                                sprintf("%.1f", sum(sel.data$Recurrence=="recurred"&sel.data$SNstatus=="Negative")/sum(sel.data$SNstatus=="Negative")*100)))
utils::write.table(as.data.frame(Rec.table),file='Z:/Project Melanoom/PaperMelanoma/Results/Rec.table.txt',
                   row.names=FALSE)
Rec.table
```

# Melanoma Specific Mortality at 5 years
```{r, eval=TRUE}
MSM.table <- c("Total", sum(sel.data$MSM==1), sprintf("%.1f", sum(sel.data$MSM==1)/nrow(sel.data)*100))
MSM.table <- rbind(MSM.table, c("Positive", sum(sel.data$MSM==1&sel.data$SNstatus=="Positive"),
                                sprintf("%.1f", sum(sel.data$MSM==1&sel.data$SNstatus=="Positive")/sum(sel.data$SNstatus=="Positive")*100)))
MSM.table <- rbind(MSM.table, c("Negative", sum(sel.data$MSM==1&sel.data$SNstatus=="Negative"),
                                sprintf("%.1f", sum(sel.data$MSM==1&sel.data$SNstatus=="Negative")/sum(sel.data$SNstatus=="Negative")*100)))
utils::write.table(as.data.frame(MSM.table),file='Z:/Project Melanoom/PaperMelanoma/Results/MSM.table.txt',
                   row.names=FALSE)
MSM.table
```

### Restrict survival at 5 years
```{r, eval=TRUE}
S.Rec[S.Rec[,1]>5, 1] <- 5 # set recurrence time to 5
S.Rec[S.Rec[,1]>5, 2] <- 0 # set censoring
S.MSM[S.MSM[,1]>5, 1] <- 5 # set follow-up time to 5
S.MSM[S.MSM[,1]>5, 2] <- 0 # set censoring
```

# Obtain C-index of AJCC7 and AJCC8
```{r, eval=TRUE}
TNM.7 <- c()
AJCC.7 <- c()
cindex.AJCC.7 <- rep(0, m)
cindex.AJCC.7.se <- rep(0, m)
cindex.AJCC.7.pos <- rep(0, m)
cindex.AJCC.7.se.pos <- rep(0, m)
cindex.AJCC.7.neg <- rep(0, m)
cindex.AJCC.7.se.neg <- rep(0, m)
for (i in 1:m){
  imputation.i <- mice::complete(imputed.data,i)
  TNM.7.i <- rep("", nrow(imputation.i))
  AJCC.7.i <- rep(0, nrow(imputation.i))
  for (patient in 1:nrow(imputation.i)){
    breslow.patient <- imputation.i[patient, "Breslow"]
    ulceration.patient <- as.character(imputation.i[patient, "Ulceration"])
    mitosis.patient <- as.character(imputation.i[patient, "Mitosis"])
    nodes.patient <- imputation.i[patient, "Tot_SNs_pos"]

    snstatus.patient <- imputation.i[patient, "SNstatus"]

    # T stage
    if (breslow.patient <= 1){
      if (ulceration.patient=="No" & mitosis.patient=="No"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T1a")
      } else if (ulceration.patient=="Yes" | mitosis.patient=="Yes"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T1b")
      }
    } else if (breslow.patient>1 & breslow.patient <= 2){
      if (ulceration.patient=="No"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T2a")
      } else if (ulceration.patient=="Yes"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T2b")
      }
    } else if (breslow.patient>2 & breslow.patient <= 4){
      if (ulceration.patient=="No"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T3a")
      } else if (ulceration.patient=="Yes"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T3b")
      }
    } else if (breslow.patient>4){
      if (ulceration.patient=="No"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T4a")
      } else if (ulceration.patient=="Yes"){
        TNM.7.i[patient] <- paste0(TNM.7.i[patient], "T4b")
      }
    }

    # N stage
    if (nodes.patient == 0){
      TNM.7.i[patient] <- paste0(TNM.7.i[patient], "N0")
    } else if (nodes.patient==1){
      TNM.7.i[patient] <- paste0(TNM.7.i[patient], "N1a")
    } else if (nodes.patient==2 | nodes.patient==3){
      TNM.7.i[patient] <- paste0(TNM.7.i[patient], "N2a")
    } else if (nodes.patient>3){
      TNM.7.i[patient] <- paste0(TNM.7.i[patient], "N3a")
    }

    # M stage for all patients in our data set
    TNM.7.i[patient] <- paste0(TNM.7.i[patient], "M0")

    # determine AJCC.7.i
    if (TNM.7.i[patient]=="T1aN0M0"){
      AJCC.7.i[patient] <- 1.1
    } else if (TNM.7.i[patient]=="T1bN0M0" | TNM.7.i[patient]=="T2aN0M0"){
      AJCC.7.i[patient] <- 1.2
    } else if (TNM.7.i[patient]=="T2bN0M0" | TNM.7.i[patient]=="T3aN0M0"){
      AJCC.7.i[patient] <- 2.1
    } else if (TNM.7.i[patient]=="T3bN0M0" | TNM.7.i[patient]=="T4aN0M0"){
      AJCC.7.i[patient] <- 2.2
    } else if (TNM.7.i[patient]=="T4bN0M0"){
      AJCC.7.i[patient] <- 2.3
    } else if (TNM.7.i[patient]=="T1aN1aM0" | TNM.7.i[patient]=="T2aN1aM0" | # N1a
               TNM.7.i[patient]=="T3aN1aM0" | TNM.7.i[patient]=="T4aN1aM0" |
               TNM.7.i[patient]=="T1aN2aM0" | TNM.7.i[patient]=="T2aN2aM0" | # N2a
               TNM.7.i[patient]=="T3aN2aM0" | TNM.7.i[patient]=="T4aN2aM0"){
      AJCC.7.i[patient] <- 3.1
    } else if (TNM.7.i[patient]=="T1bN1aM0" | TNM.7.i[patient]=="T2bN1aM0" | # N1a
               TNM.7.i[patient]=="T3bN1aM0" | TNM.7.i[patient]=="T4bN1aM0" |
               TNM.7.i[patient]=="T1bN2aM0" | TNM.7.i[patient]=="T2bN2aM0" | # N2a
               TNM.7.i[patient]=="T3bN2aM0" | TNM.7.i[patient]=="T4bN2aM0" |
               TNM.7.i[patient]=="T1aN1bM0" | TNM.7.i[patient]=="T2aN1bM0" | # N1b
               TNM.7.i[patient]=="T3aN1bM0" | TNM.7.i[patient]=="T4aN1bM0" |
               TNM.7.i[patient]=="T1aN2bM0" | TNM.7.i[patient]=="T2aN2bM0" | # N2b
               TNM.7.i[patient]=="T3aN2bM0" | TNM.7.i[patient]=="T4aN2bM0" |
               TNM.7.i[patient]=="T1aN2cM0" | TNM.7.i[patient]=="T2aN2cM0" | # N2c
               TNM.7.i[patient]=="T3aN2cM0" | TNM.7.i[patient]=="T4aN2cM0"){
      AJCC.7.i[patient] <- 3.2
    } else {
      AJCC.7.i[patient] <- 3.3
    }
  }

  # save TNM.7 and AJCC.7 for each imputated data set
  TNM.7 <- cbind(TNM.7, TNM.7.i)
  AJCC.7 <- cbind(AJCC.7, AJCC.7.i)

  # compute C-index
  rc <- Hmisc::rcorr.cens(-AJCC.7.i, S.Rec) # add a minus to revert class order: from worst to best
  cindex.AJCC.7[i]<-rc["C Index"]
  cindex.AJCC.7.se[i]<-rc["S.D."]/2

  # compute C-index for only positive sentinel node patients
  rc.pos <- Hmisc::rcorr.cens(-AJCC.7.i[imputation.i$SNstatus=="Positive"], S.Rec[imputation.i$SNstatus=="Positive",])
  cindex.AJCC.7.pos[i]<-rc.pos["C Index"]
  cindex.AJCC.7.se.pos[i]<-rc.pos["S.D."]/2

  # compute C-index for only negative sentinel node patients
  rc.neg <- Hmisc::rcorr.cens(-AJCC.7.i[imputation.i$SNstatus=="Negative"], S.Rec[imputation.i$SNstatus=="Negative",])
  cindex.AJCC.7.neg[i]<-rc.neg["C Index"]
  cindex.AJCC.7.se.neg[i]<-rc.neg["S.D."]/2
}
# combine C-index for each imputed data set
cindex.mi.AJCC.7<-Rubin.combine(cindex.AJCC.7,cindex.AJCC.7.se)
cindex.mi.AJCC.7.pos<-Rubin.combine(cindex.AJCC.7.pos,cindex.AJCC.7.se.pos)
cindex.mi.AJCC.7.neg<-Rubin.combine(cindex.AJCC.7.neg,cindex.AJCC.7.se.neg)

# save C-index and confidence interval
utils::write.table(rbind(c("All patients:", sprintf('%.2f', cindex.mi.AJCC.7$est),
              paste0("[", sprintf('%.2f', cindex.mi.AJCC.7$est+qnorm(.025)*cindex.mi.AJCC.7$se),
                      "; ", sprintf('%.2f', cindex.mi.AJCC.7$est+qnorm(.975)*cindex.mi.AJCC.7$se), "]")),
            c("Positive SN patients:", sprintf('%.2f', cindex.mi.AJCC.7.pos$est),
                  paste0("[", sprintf('%.2f', cindex.mi.AJCC.7.pos$est+qnorm(.025)*cindex.mi.AJCC.7.pos$se),
                         "; ", sprintf('%.2f', cindex.mi.AJCC.7.pos$est+qnorm(.975)*cindex.mi.AJCC.7.pos$se), "]")),
            c("Negative SN patients:", sprintf('%.2f', cindex.mi.AJCC.7.neg$est),
                  paste0("[", sprintf('%.2f', cindex.mi.AJCC.7.neg$est+qnorm(.025)*cindex.mi.AJCC.7.neg$se),
                         "; ", sprintf('%.2f', cindex.mi.AJCC.7.neg$est+qnorm(.975)*cindex.mi.AJCC.7.neg$se), "]"))),
            file='Z:/Project Melanoom/PaperMelanoma/Results/AJCC.7.Cindex.txt', row.names=FALSE, col.names=FALSE)

#####
##### COMPARE MODEL WITH AJCC.8 CLASIFCATION
#####
TNM.8 <- c()
AJCC.8 <- c()
cindex.AJCC.8 <- rep(0, m)
cindex.AJCC.8.se <- rep(0, m)
cindex.AJCC.8.pos <- rep(0, m)
cindex.AJCC.8.se.pos <- rep(0, m)
cindex.AJCC.8.neg <- rep(0, m)
cindex.AJCC.8.se.neg <- rep(0, m)
for (i in 1:m){
  imputation.i <- mice::complete(imputed.data,i)
  TNM.8.i <- rep("", nrow(imputation.i))
  AJCC.8.i <- rep(0, nrow(imputation.i))
  for (patient in 1:nrow(imputation.i)){
    breslow.patient <- imputation.i[patient, "Breslow"]
    ulceration.patient <- as.character(imputation.i[patient, "Ulceration"])
    mitosis.patient <- as.character(imputation.i[patient, "Mitosis"])
    nodes.patient <- imputation.i[patient, "Tot_SNs_pos"]

    # T stage
    if (breslow.patient <= 1){
      if (ulceration.patient=="No" & breslow.patient < 0.8){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T1a")
      } else {
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T1b")
      }
    } else if (breslow.patient>1 & breslow.patient <= 2){
      if (ulceration.patient=="No"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T2a")
      } else if (ulceration.patient=="Yes"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T2b")
      }
    } else if (breslow.patient>2 & breslow.patient <= 4){
      if (ulceration.patient=="No"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T3a")
      } else if (ulceration.patient=="Yes"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T3b")
      }
    } else if (breslow.patient>4){
      if (ulceration.patient=="No"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T4a")
      } else if (ulceration.patient=="Yes"){
        TNM.8.i[patient] <- paste0(TNM.8.i[patient], "T4b")
      }
    }

    # N stage
    if (nodes.patient == 0){
      TNM.8.i[patient] <- paste0(TNM.8.i[patient], "N0")
    } else if (nodes.patient==1){
      TNM.8.i[patient] <- paste0(TNM.8.i[patient], "N1a")
    } else if (nodes.patient==2 | nodes.patient==3){
      TNM.8.i[patient] <- paste0(TNM.8.i[patient], "N2a")
    } else if (nodes.patient>3){
      TNM.8.i[patient] <- paste0(TNM.8.i[patient], "N3a")
    }

    # M stage for all patients in our data set
    TNM.8.i[patient] <- paste0(TNM.8.i[patient], "M0")

    # determine AJCC.8.i
    if (TNM.8.i[patient]=="T1aN0M0"){
      AJCC.8.i[patient] <- 1.1
    } else if (TNM.8.i[patient]=="T1bN0M0" | TNM.8.i[patient]=="T2aN0M0"){
      AJCC.8.i[patient] <- 1.2
    } else if (TNM.8.i[patient]=="T2bN0M0" | TNM.8.i[patient]=="T3aN0M0"){
      AJCC.8.i[patient] <- 2.1
    } else if (TNM.8.i[patient]=="T3bN0M0" | TNM.8.i[patient]=="T4aN0M0"){
      AJCC.8.i[patient] <- 2.2
    } else if (TNM.8.i[patient]=="T4bN0M0"){
      AJCC.8.i[patient] <- 2.3
    } else if (TNM.8.i[patient]=="T1aN1aM0" | TNM.8.i[patient]=="T1bN1aM0" | TNM.8.i[patient]=="T2aN1aM0"
               | TNM.8.i[patient]=="T1aN2aM0" | TNM.8.i[patient]=="T1bN2aM0" | TNM.8.i[patient]=="T2aN2aM0"){
      AJCC.8.i[patient] <- 3.1
    } else if (TNM.8.i[patient]=="T2bN1aM0" | TNM.8.i[patient]=="T3aN1aM0"){
      AJCC.8.i[patient] <- 3.2
    } else if (TNM.8.i[patient]=="T4bN3aM0"){
      AJCC.8.i[patient] <- 3.4
    } else {
      AJCC.8.i[patient] <- 3.3
    }

  }

  # save TNM.8 and AJCC.8 for each imputated data set
  TNM.8 <- cbind(TNM.8, TNM.8.i)
  AJCC.8 <- cbind(AJCC.8, AJCC.8.i)

  # compute C-index
  rc <- Hmisc::rcorr.cens(-AJCC.8.i, S.Rec) # add a minus to revert class order: from worst to best
  cindex.AJCC.8[i]<-rc["C Index"]
  cindex.AJCC.8.se[i]<-rc["S.D."]/2

  # compute C-index for only positive sentinel node patients
  rc.pos <- Hmisc::rcorr.cens(-AJCC.8.i[imputation.i$SNstatus=="Positive"], S.Rec[imputation.i$SNstatus=="Positive",])
  cindex.AJCC.8.pos[i]<-rc.pos["C Index"]
  cindex.AJCC.8.se.pos[i]<-rc.pos["S.D."]/2

  # compute C-index for only negative sentinel node patients
  rc.neg <- Hmisc::rcorr.cens(-AJCC.8.i[imputation.i$SNstatus=="Negative"], S.Rec[imputation.i$SNstatus=="Negative",])
  cindex.AJCC.8.neg[i]<-rc.neg["C Index"]
  cindex.AJCC.8.se.neg[i]<-rc.neg["S.D."]/2
}
# combine C-index for each imputed data set
cindex.mi.AJCC.8<-Rubin.combine(cindex.AJCC.8,cindex.AJCC.8.se)
cindex.mi.AJCC.8.pos<-Rubin.combine(cindex.AJCC.8.pos,cindex.AJCC.8.se.pos)
cindex.mi.AJCC.8.neg<-Rubin.combine(cindex.AJCC.8.neg,cindex.AJCC.8.se.neg)

# save C-index and confidence interval
utils::write.table(rbind(c("All patients:", sprintf('%.2f', cindex.mi.AJCC.8$est),
                        paste0("[", sprintf('%.2f', cindex.mi.AJCC.8$est+qnorm(.025)*cindex.mi.AJCC.8$se),
                               "; ", sprintf('%.2f', cindex.mi.AJCC.8$est+qnorm(.975)*cindex.mi.AJCC.8$se), "]")),
                  c("Positive SN patients:", sprintf('%.2f', cindex.mi.AJCC.8.pos$est),
                        paste0("[", sprintf('%.2f', cindex.mi.AJCC.8.pos$est+qnorm(.025)*cindex.mi.AJCC.8.pos$se),
                               "; ", sprintf('%.2f', cindex.mi.AJCC.8.pos$est+qnorm(.975)*cindex.mi.AJCC.8.pos$se), "]")),
                  c("Negative SN patients", sprintf('%.2f', cindex.mi.AJCC.8.neg$est),
                        paste0("[", sprintf('%.2f', cindex.mi.AJCC.8.neg$est+qnorm(.025)*cindex.mi.AJCC.8.neg$se),
                               "; ", sprintf('%.2f', cindex.mi.AJCC.8.neg$est+qnorm(.975)*cindex.mi.AJCC.8.neg$se), "]"))),
            file='Z:/Project Melanoom/PaperMelanoma/Results/AJCC.8.Cindex.txt', row.names=FALSE, col.names=FALSE)

# table of number of AJCC.7 and AJCC.8
table.AJCC.7 <- c()
table.AJCC.8 <- c()
for (i in 1:m){
  table.AJCC.7 <- cbind(table.AJCC.7, as.numeric(table(AJCC.7[,i])))
  table.AJCC.8 <- cbind(table.AJCC.8, as.numeric(table(AJCC.8[,i])))
}
table.AJCC.7.8 <- cbind(as.numeric(names(table(AJCC.8[,1]))),
                        c(round(rowMeans(table.AJCC.7), 0), 0),
                        round(rowMeans(table.AJCC.8), 0))
utils::write.table(table.AJCC.7.8,
            file='Z:/Project Melanoom/PaperMelanoma/Results/table.AJCC.7.and.8.txt', row.names=FALSE, col.names=FALSE)
table.AJCC.7.8
```

# Full model for recurrence
```{r, eval=TRUE}
form.full.Rec <- S.Rec ~
  SNstatus +
  Sex +
  log(Age.SN) +
  Ulceration +
  Loc_CAT +
  Histology +
  log(Breslow) +
  multiple.fields +
  Tot_SNs_neg +
  Tot_SNs_pos +
  log(Rdamcrit) +
  Dewar +
  SNstatus:Sex +
  SNstatus:log(Age.SN) +
  SNstatus:Ulceration +
  SNstatus:Loc_CAT +
  SNstatus:Histology +
  SNstatus:log(Breslow) +
  SNstatus:multiple.fields
f.mi.full.Rec <- Hmisc::fit.mult.impute(form.full.Rec, cph, xtrans=imputed.data,
                                 data=data.to.be.imputed,n.impute=m, pr=FALSE,
                                 fit.reps=TRUE, y=TRUE, x=TRUE, se.fit=TRUE)
f.mi.full.Rec
stats::anova(f.mi.full.Rec)
summary(f.mi.full.Rec)
```

# Final model for recurrence selected by backward selection with p = 0.01
```{r, eval=TRUE}
c.Breslow <- mean(log(last.imputed.data.set$Breslow))
form.BS.Rec <- S.Rec ~
  SNstatus +
  log(Age.SN) +
  Ulceration +
  Loc_CAT +
  I(log(Breslow)-c.Breslow) +
  log(Rdamcrit) +
  SNstatus:I(log(Breslow)-c.Breslow)
f.mi.BS.Rec <- Hmisc::fit.mult.impute(form.BS.Rec,cph,xtrans=imputed.data,data=data.to.be.imputed,n.impute=m,
                           pr=FALSE,fit.reps=TRUE,y=TRUE,x=TRUE,se.fit=TRUE)
# round(stats::anova(f.mi.BS.Rec)[order(stats::anova(f.mi.BS.Rec)[, 'P']),], 3)
stats::anova(f.mi.BS.Rec)
```

# Refitted full model for melanoma specific mortality
```{r, eval=TRUE}
form.full.MSM.refit <- S.MSM ~
  SNstatus +
  Sex +
  log(Age.SN) +
  Ulceration +
  Loc_CAT +
  Histology +
  log(Breslow) +
  multiple.fields +
  Tot_SNs_neg +
  Tot_SNs_pos +
  log(Rdamcrit) +
  Dewar +
  SNstatus:Sex +
  SNstatus:log(Age.SN) +
  SNstatus:Ulceration +
  SNstatus:Loc_CAT +
  SNstatus:Histology +
  SNstatus:log(Breslow) +
  SNstatus:multiple.fields
f.mi.full.MSM.refit <- Hmisc::fit.mult.impute(form.full.MSM.refit,cph,xtrans=imputed.data,data=data.to.be.imputed,n.impute=m,
                                 pr=FALSE,fit.reps=TRUE,y=TRUE,x=TRUE,se.fit=TRUE)
f.mi.full.MSM.refit
summary(f.mi.full.MSM.refit)
stats::anova(f.mi.full.MSM.refit)
```

# Refitted final model for melanoma specific mortality
```{r, eval=TRUE}
form.BS.MSM.refit <- S.MSM ~
  SNstatus +
  log(Age.SN) +
  Ulceration +
  Loc_CAT +
  I(log(Breslow)-c.Breslow) +
  log(Rdamcrit) +
  SNstatus:I(log(Breslow)-c.Breslow)
f.mi.BS.MSM.refit <- Hmisc::fit.mult.impute(form.BS.MSM.refit,cph,xtrans=imputed.data,data=data.to.be.imputed,n.impute=m,
                                  pr=FALSE,fit.reps=TRUE,y=TRUE,x=TRUE,se.fit=TRUE)
# round(anova(f.mi.BS.MSM.refit)[order(anova(f.mi.BS.MSM.refit)[, 'P']),], 3)
f.mi.BS.MSM.refit
summary(f.mi.BS.MSM.refit)
stats::anova(f.mi.BS.MSM.refit)
```

# Calibrated final model for melanoma specific mortality
Fit disease specific mortality to the linear predictor of recurrence
```{r, eval=TRUE}
lp.BS<-f.mi.BS.Rec$linear
f.mi.BS.MSM<-rms::cph(S.MSM~lp.BS,y=TRUE,x=TRUE)
utils::write.table(paste0(sprintf("%.2f", stats::coef(f.mi.BS.MSM)), " [",
            sprintf("%.2f", as.numeric(stats::confint(f.mi.BS.MSM))[1]), "; ",
            sprintf("%.2f", as.numeric(stats::confint(f.mi.BS.MSM))[2]), "]"),
            file='Z:/Project Melanoom/PaperMelanoma/Results/calibration.MSS.txt', row.names=FALSE, col.names=FALSE)
MSM.cal.fact <- stats::coef(f.mi.BS.MSM)
stats::coef(f.mi.BS.MSM)
stats::confint(f.mi.BS.MSM)
```

### Create variables with results
##### Full model
```{r, eval=TRUE}
for (model in c('Rec', 'MSM.refit')){
  f.mi.full <- eval(parse(text=paste0('f.mi.full.', model)))

  CI.lower.neg <- exp(stats::confint(f.mi.full)[,1])
  CI.upper.neg <- exp(stats::confint(f.mi.full)[,2])
  CI.neg <- paste0("[", sprintf("%.2f", CI.lower.neg), "; ", sprintf("%.2f", CI.upper.neg), "]")
  CI.lower.pos <- c(CI.lower.neg[2:12]*CI.lower.neg[20:30], CI.lower.neg[14:19])
  CI.upper.pos <- c(CI.upper.neg[2:12]*CI.upper.neg[20:30], CI.upper.neg[14:19])
  CI.pos <- paste0("[", sprintf("%.2f", CI.lower.pos), "; ", sprintf("%.2f", CI.upper.pos), "]")

  anova.full <- stats::anova(f.mi.full)[,1]

  full.table <- cbind(c(NA, sprintf("%.2f", exp(f.mi.full$coefficients[2:13])), rep(NA, 5)), # COEF NEG
                      c(NA, CI.neg[2:13], rep(NA, 5)), # CI NEG
                      sprintf("%.2f", c(exp(f.mi.full$coefficients[1]), # COEF POS
                        exp(f.mi.full$coefficients[2:12])*exp(f.mi.full$coefficients[20:30]),
                        exp(f.mi.full$coefficients[14]), exp(f.mi.full$coefficients[15:19]))),
                      c(CI.neg[1], CI.pos), # CI POS
                      c(sprintf("%.1f", anova.full[c(1, 3, 5, 7, 9)]), rep(NA, 2), # CHI2 NEG
                            sprintf("%.1f", anova.full[11]), rep(NA, 2),
                            sprintf("%.1f", anova.full[c(13, 15, 17, 19, 20)]), rep(NA, 3)),
                      c(sprintf("%.1f", anova.full[c(2, 21, 22, 23, 24)]), rep(NA, 2), # CHI2 POS
                            sprintf("%.1f", anova.full[25]), rep(NA, 2),
                            sprintf("%.1f", anova.full[c(26:27, 18)]), rep(NA, 5)))

  ncols <- 6
  final.table <- rbind(full.table[1:4,],
                       rep(NA, ncols), # location
                       c("(ref)", NA, "(ref)", rep(NA, 3)), # ref arm
                       full.table[5:7,], # other locations
                       rep(NA, ncols), # histology
                       c("(ref)", NA, "(ref)", rep(NA, 3)), # ref SMM
                       full.table[8:14,],
                       rep(NA, ncols), # Dewar
                       c(rep(NA, 2), "(ref)", rep(NA, 3)), # ref subcap
                       full.table[15:18,]) # other Dewar

  colnames(final.table) <- c("HR.neg", "CI.neg", "HR.pos", "CI.pos", "Chi2.neg", "Chi2.pos")
  assign(paste0('final.full.table.', model), as.data.frame(final.table))
}
```

##### Final model
```{r, eval=TRUE}
for (model in c('Rec', 'MSM.refit')){
  f.mi.BS <- eval(parse(text=paste0('f.mi.BS.', model)))

  CI.lower.neg <- exp(confint(f.mi.BS)[,1])
  CI.upper.neg <- exp(confint(f.mi.BS)[,2])
  CI.neg <- paste0("[", sprintf("%.2f", CI.lower.neg), "; ", sprintf("%.2f", CI.upper.neg), "]")

  anova.BS <- anova(f.mi.BS)[,1]

  CI.pos <- paste0("[", sprintf("%.2f", exp(confint(f.mi.BS)[7,1])*exp(confint(f.mi.BS)[9,1])),
                   "; ", sprintf("%.2f", exp(confint(f.mi.BS)[7,2])*exp(confint(f.mi.BS)[9,2])), "]")

  BS.table <- cbind(c(NA, sprintf("%.2f", exp(f.mi.BS$coefficients[2:7])), NA), # COEF NEG
                    c(NA, CI.neg[2:7], NA), # CI NEG
                    sprintf("%.2f", exp(f.mi.BS$coefficients[1:8])*c(rep(1, 6), exp(f.mi.BS$coefficients[9]), 1)), #COEF POS
                    c(CI.neg[1:6], CI.pos, CI.neg[8]), # CI POS
                    c(NA, sprintf("%.1f", anova.BS[3:5]), rep(NA, 2), sprintf("%.1f", anova.BS[c(6, 8)])), # CHI2 NEG
                    c(sprintf("%.1f", anova.BS[1]), rep(NA, 5), # CHI2 POS
                      sprintf("%.1f", anova.BS[9]), NA))

  BS.table <- rbind(BS.table[1:3,], rep(NA, 6), c("(ref)", NA, "(ref)", rep(NA, 3)), BS.table[4:8,])

  colnames(BS.table) <- c("HR.neg", "CI.neg", "HR.pos", "CI.pos", "Chi2.neg", "Chi2.pos")

  assign(paste0('final.BS.table.', model), as.data.frame(BS.table))
}
```

# Plot calibration of all centers combined and all centers seperate 
for recurrence and melanoma specific mortality refit 
write results to Excel
```{r, eval=TRUE}
horizon <- 5
for (model in list('Rec', 'MSM.refit')){
  if (model == "Rec"){
    # plot predict
    png(file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Figures/plot.predict.Rec.png"))
    plot.predict <- plot(Predict(f.mi.full.Rec))
    show(plot.predict)
    grDevices::dev.off()

    # plot predict Breslow
    png(file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Figures/plot.predict.Breslow.Rec.png"))
    plot.Breslow <- plot(Predict(f.mi.full.Rec, Breslow=0:20, SNstatus), ~ Breslow, groups="SNstatus",
                         adj.subtitle=FALSE, lwd=2, labels=FALSE,
                         par.settings=list(superpose.line=list(lty=c(1, 2), col=c("red", "blue"))),
                         key=list(cex=.8,corner = c(0.1, .9),lines=list(col=c("red","blue"), lty=c(1,2), lwd=2),text=list(c("Negative","Positive"))))
    show(plot.Breslow)
    grDevices::dev.off()
  }

  # discrimination full and backward selected model
  for (type in c("full", "BS")){
    f.mi <- eval(parse(text=paste0('f.mi.', type, '.', model)))
    if (model=="Rec"){
      S <- S.Rec
    }
    else if (model=="MSM.refit"){
      S <- S.MSM
    }
    p <- matrix(NA, nrow(sel.data), m)
    for (i in 1:m){
      # predicted lp for imputation i
      lp.i <- predict(f.mi,newdata=mice::complete(imputed.data,i), type="lp")
      # baseline hazard
      f.basehaz <- survival::basehaz(f.mi,TRUE)
      h0.i <- f.basehaz$hazard[f.basehaz$time==max(f.basehaz$time[f.basehaz$time<=horizon])]
      # probabilities
      p.i <- fun.event(lp=lp.i, h0=h0.i)
      p[, i] <- p.i
    }

    # omit the observation with predicted probability = 1
    omit <- unique(c(which(p[,1]==1), which(p[,2]==1), which(p[,3]==1), which(p[,4]==1), which(p[,5]==1)))
    if (length(omit)>0){
      cat('Omit:', omit, '\n')
      p <- p[-omit,]
      S <- S[-omit,]
    }

    out <- val.surv.mi(p,S,g=5,main="All centers",
                       file_path=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Figures/all.centers.", model, '.', type, ".png"),
                       save_plots=TRUE,time=NULL,lim=c(0,1),dist=TRUE)

    final.full.table <- eval(parse(text=paste0('final.', type, '.table.', model)))
    final.full.table["C-index", "HR.neg"] <- sprintf('%.2f', out$cindex)
    final.full.table["C-index", "CI.neg"] <- paste0("[", sprintf('%.2f', out$cindex.lower),
                                                   "; ", sprintf('%.2f', out$cindex.upper), "]")

    assign(paste0('final.', type, '.table.', model), final.full.table)
  }
}

# MSM recalibration
for (type in c("full", "BS")){
  f.mi <- eval(parse(text=paste0('f.mi.', type, '.Rec')))
  cindex.MSM.refit <- rep(0, m)
  cindex.se.MSM.refit <- rep(0, m)
  for (i in 1:m){
    rc <- Hmisc::rcorr.cens(-predict(f.mi,newdata=mice::complete(imputed.data,i), type="lp"), S.MSM)
    cindex.MSM.refit[i]<-rc["C Index"]
    cindex.se.MSM.refit[i]<-rc["S.D."]/2
  }
  cindex.mi.MSM.refit<-Rubin.combine(cindex.MSM.refit,cindex.se.MSM.refit)

  final.full.table <- eval(parse(text=paste0('final.', type, '.table.Rec')))
  final.full.table["C-index MSM", "HR.neg"] <- sprintf('%.2f', cindex.mi.MSM.refit$est)
  final.full.table["C-index MSM", "CI.neg"] <- paste0("[", sprintf('%.2f', cindex.mi.MSM.refit$est+qnorm(.025)*cindex.mi.MSM.refit$se),
                                                 "; ", sprintf('%.2f', cindex.mi.MSM.refit$est+qnorm(.975)*cindex.mi.MSM.refit$se), "]")

  assign(paste0('final.', type, '.table.Rec'), final.full.table)
}

# replace NA by blank
final.full.table.Rec[is.na(final.full.table.Rec)] <- ""
final.full.table.MSM.refit[is.na(final.full.table.MSM.refit)] <- ""
final.BS.table.Rec[is.na(final.BS.table.Rec)] <- ""
final.BS.table.MSM.refit[is.na(final.BS.table.MSM.refit)] <- ""

# set rownames
final.full.table.Rec <- as.data.frame(final.full.table.Rec)
row.names(final.full.table.Rec) <- c("Positive SN status", "Male",
                                    "Age", "Ulceration", "Location",
                                    "Arm", "Leg", "Trunk", "Head and neck",
                                    "Histology", "SSM", "NM", "ALM", "Other",
                                    "Breslow", "Multiple fields", 
                                    "Total number of nodes",
                                    "SN tumour burden", 
                                    "Location metastasis in lymph node",
                                    "Subcap", "Combined", "Parenchymal",
                                    "Multifocal", "Extensive",
                                    rownames(final.full.table.Rec)[25:26])
final.full.table.MSM.refit <- as.data.frame(final.full.table.MSM.refit)
row.names(final.full.table.MSM.refit) <- c("Positive SN status", "Male",
                                          "Age", "Ulceration", "Location",
                                          "Arm", "Leg", "Trunk", "Head and neck",
                                          "Histology", "SSM", "NM", "ALM", "Other",
                                          "Breslow", "Multiple fields", 
                                          "Total number of nodes",
                                          "SN tumour burden", 
                                          "Location metastasis in lymph node",
                                          "Subcap", "Combined", "Parenchymal",
                                          "Multifocal", "Extensive",
                                          row.names(final.full.table.Rec)[25])
final.BS.table.Rec <- as.data.frame(final.BS.table.Rec)
row.names(final.BS.table.Rec) <- c("Positive SN status", "Age", "Ulceration",
                                   "Location", "Arm", "Leg", "Trunk", 
                                   "Head and neck",
                                   "Breslow", "SN tumour burden", 
                                   row.names(final.BS.table.Rec)[11:12])
final.BS.table.MSM.refit <- as.data.frame(final.BS.table.MSM.refit)
row.names(final.BS.table.MSM.refit) <- c("Positive SN status", "Age", "Ulceration",
                                   "Location", "Arm", "Leg", "Trunk", 
                                   "Head and neck",
                                   "Breslow", "SN tumour burden", 
                                   row.names(final.BS.table.MSM.refit)[11])

# save tables
write.table(final.full.table.Rec,
            file='Z:/Project Melanoom/PaperMelanoma/Results/final.full.table.Rec.txt', sep=",")
write.table(final.full.table.MSM.refit,
            file='Z:/Project Melanoom/PaperMelanoma/Results/final.full.table.MSM.refit.txt', sep=",")
write.table(final.BS.table.Rec,
            file='Z:/Project Melanoom/PaperMelanoma/Results/final.BS.table.Rec.txt', sep=",")
write.table(final.BS.table.MSM.refit,
            file='Z:/Project Melanoom/PaperMelanoma/Results/final.BS.table.MSM.refit.txt', sep=",")

# show tables
final.full.table.Rec
final.full.table.MSM.refit
final.BS.table.Rec
final.BS.table.MSM.refit
```

# Cross-validation recurrence 5-years
```{r, eval=TRUE}
Centers <- sort(as.character(unique(sel.data$Center)))
Centers.anonimized <- c("A", "B", "C", "D")
cuts <- 5
for (model in c('Rec', 'MSM')){
  if (model == 'Rec'){
    S.model <- S.Rec
  }
  if (model == 'MSM'){
    S.model <- S.MSM
  }

  for (type in c('full', 'BS')){
    for (j in 1:4){
      S.j<-S.model[data.to.be.imputed$Center==Centers[j],]
      S.notj<-S.model[data.to.be.imputed$Center!=Centers[j],]
      S.Rec.notj<-S.Rec[data.to.be.imputed$Center!=Centers[j],]

      form.model<-eval(parse(text=paste0('form.', type, '.Rec')))
      form.notj<-update(form.model, S.Rec.notj  ~ . )
      f.mi.Rec.notj<-Hmisc::fit.mult.impute(form.notj,cph,xtrans=imputed.data,data=data.to.be.imputed,
                                 n.impute=m,pr=FALSE,fit.reps=TRUE,y=TRUE,x=TRUE,se.fit=TRUE,
                                 sub=data.to.be.imputed$Center!=Centers[j])

      if (model=="Rec"){
        f.basehaz.notj<-survival::basehaz(f.mi.Rec.notj,TRUE)
        h0.notj<-f.basehaz.notj$hazard[f.basehaz.notj$time==max(f.basehaz.notj$time[f.basehaz.notj$time<=horizon])]
      } else if (model=="MSM"){
        lp.notj<-f.mi.Rec.notj$linear
        f.MSM.notj<-rms::cph(S.notj~lp.notj,y=TRUE,x=TRUE)

        f.basehaz.notj<-basehaz(f.MSM.notj,TRUE)
        h0.notj<-f.basehaz.notj$hazard[f.basehaz.notj$time==max(f.basehaz.notj$time[f.basehaz.notj$time<=horizon])]
      }

      for (select.value in c("Positive", "Negative", "All")){
        # identify those patients that are selected
        if (select.value == "All"){
          select.patients <- TRUE
        } else if (select.value != "All"){
          select.patients <- data.to.be.imputed[data.to.be.imputed$Center==Centers[j],]$SNstatus==select.value
        }

        # calibration with metrics
        S <- S.j[select.patients,]
        p <- matrix(NA, nrow(S), m)
        for (i in 1:m){
          lp.i<-predict(f.mi.Rec.notj,newdata=mice::complete(imputed.data,i)[data.to.be.imputed$Center==Centers[j],], type="lp")

          if (model=="MSM"){
            lp.i<-predict(f.MSM.notj,newdata=lp.i)
          }

          if (select.value != "All"){
            lp.i <- lp.i[select.patients]
          }

          # baseline hazard
          if (model=="Rec"){
            f.basehaz<-basehaz(f.mi.Rec.notj,TRUE)
          }
          else if (model=="MSM"){
            f.basehaz<-basehaz(f.MSM.notj,TRUE)
          }
          h0.i <- f.basehaz$hazard[f.basehaz$time==max(f.basehaz$time[f.basehaz$time<=horizon])]

          # probabilities
          p.i <- fun.event(lp=lp.i, h0=h0.i)
          p[, i] <- p.i
        }

        # omit the observation with predicted probability = 1
        omit <- unique(c(which(p[,1]==1), which(p[,2]==1), which(p[,3]==1), which(p[,4]==1), which(p[,5]==1)))
        if (length(omit)>0){
          cat('Omit:', omit, '\n')
          p <- p[-omit,]
          S <- S[-omit,]
        }

        out <- val.surv.mi(p, S, g=5, main=paste("Center", Centers.anonimized[j]),
                           file_path=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Figures/", model, '.', select.value, '.', type, '.', Centers[j], ".png"),
                           save_plots=TRUE,time=NULL,lim=c(0,1),dist=TRUE)
      }
    }
  }
}

# combine calibration plots into one
for (select.value in c("All", "Positive", "Negative")){
  for (y in c("Rec", "MSM")){
    png(file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/", y, ".", select.value, ".png"), width=16, height=16, units="cm", res=300)
    par(mar=rep(0, 4))
    layout(matrix(1:4, ncol=2, byrow=TRUE))
    Centers.val <- rep(1:4, 3)
    for (i in 1:4){
      plot(NA, xlim=0:1, ylim=0:1, xaxt="n", yaxt="n", bty="n")
      img <- readPNG(paste0("Z:/Project Melanoom/PaperMelanoma/Results/Figures/", y, ".", select.value, ".BS.", Centers[Centers.val[i]], ".png"))
      rasterImage(img, 0, 0, 1, 1)
    }
    grDevices::dev.off()
  }
}
```

# Nomogram
```{r, eval=TRUE}
# Limits of Age, Breslow, Rdamcrit
Age.class <- seq(20, 80, 20)
Breslow.class <- c(seq(0.1, 0.9, 0.2), 1:7)
Rdamcrit.class <- c(seq(1, 10, 2)/100, seq(1, 10, 2)/10, seq(1, 10, 2))

# initial nomogram
nom.0 <- nomogram(f.mi.BS.Rec,maxscale=10,
                Breslow=Breslow.class, Rdamcrit=Rdamcrit.class, Age.SN=Age.class)

# Baseline hazard
rc.Rec <- (1/attributes(nom.0)$info$sc)
int.Rec <- attributes(nom.0)$info$Intercept
f.Rec.basehaz <- basehaz(f.mi.BS.Rec,TRUE)
h0.Rec <- f.Rec.basehaz$hazard[f.Rec.basehaz$time==max(f.Rec.basehaz$time[f.Rec.basehaz$time<=horizon])]
lp.range <- int.Rec+rc.Rec*(0:10)*2
par(mar = rep(0, 4))
nom <- nomogram(f.mi.BS.Rec, maxscale=10,
              Breslow=Breslow.class, Rdamcrit=Rdamcrit.class, Age.SN=Age.class,
              lp=TRUE, fun.at=fun.event(lp=lp.range, h0=h0.Rec))
attributes(nom)$names[attributes(nom)$names=="Age.SN"]<-"Age"
attributes(nom)$names[attributes(nom)$names=="Loc_CAT"]<-"Location"
attributes(nom)$names[attributes(nom)$names=="Rdamcrit"]<-"Tumor burden"
attributes(nom)$names[attributes(nom)$names=="Breslow (SNstatus=Positive)"]<-"Breslow + positive SN"
attributes(nom)$names[attributes(nom)$names=="Breslow (SNstatus=Negative)"]<-"Breslow + negative SN"
plot(nom, total.sep.page=TRUE, col.grid=gray(c(0.8, 0.95)))
nom.0
nom
```

# Risk score distribution
```{r, eval=TRUE}
rc.MSM <- f.mi.BS.MSM$coef[1]*rc.Rec
int.MSM <- f.mi.BS.MSM$coef[1]*int.Rec

max.range <- 16
points.range <- 0:max.range
lp.points.Rec <- int.Rec+rc.Rec*points.range
lp.points.MSM <- int.MSM+rc.MSM*points.range

f.MSM.basehaz <- basehaz(f.mi.BS.MSM,TRUE)
h0.MSM <- f.MSM.basehaz$hazard[f.MSM.basehaz$time==max(f.MSM.basehaz$time[f.MSM.basehaz$time<=horizon])]
lp.MSM <- f.mi.BS.MSM$linear

Breslow.trunc <- last.imputed.data.set$Breslow
Breslow.trunc[last.imputed.data.set$Breslow<0.1] <- .1
Breslow.trunc[last.imputed.data.set$Breslow>7] <- 7
lp.score.Rec <- predict(f.mi.BS.Rec,newdata=data.frame(SNstatus=last.imputed.data.set$SNstatus,
                                                Age.SN=last.imputed.data.set$Age.SN,
                                                Ulceration=last.imputed.data.set$Ulceration,
                                                Loc_CAT=last.imputed.data.set$Loc_CAT,
                                                Breslow=Breslow.trunc,
                                                Rdamcrit=last.imputed.data.set$Rdamcrit))
mean(lp.score.Rec)
score.Rec <- round((lp.score.Rec-int.Rec)/rc.Rec,0)
max.breaks <- max.range+1
h.Rec <- hist(score.Rec,plot=FALSE,breaks=0:max.breaks,right=FALSE)

# score table
data.frame(table(score.Rec)/length(score.Rec))
```

# Plot of risk score distribution
```{r, eval=TRUE, message=FALSE}
h.plot <- h.Rec
h.plot$density <- 100*h.Rec$density
p.Rec <- fun.event(lp=lp.points.Rec, h0=h0.Rec)
p.MSM <- fun.event(lp=lp.points.MSM, h0=h0.MSM)
x.lim <- c(0, max.range+1)
y.lim <- c(0, 100)
y.lim.hist <- c(0, 25)
png(file=paste0("Z:/Project Melanoom/PaperMelanoma/Results/Risk.distribution.png"))
par(mar = c(5,5,2,5))
plot(h.plot,freq=FALSE,axes=FALSE, xlab=NA, xlim=x.lim, ylab=NA,ylim=y.lim.hist,main=NA,col='white')
abline(h=(0:30)*1,col="light grey",lty=2)
axis(side = 4)
mtext(side = 4, line = 3, 'Risk score distribution (%)')
par(new = TRUE)
plot(h.plot,freq=FALSE,axes=FALSE, xlab=NA, xlim=x.lim, ylab=NA,ylim=y.lim.hist,main=NA,col="white")
par(new = TRUE)
plot(points.range,p.Rec*100,type="b",lwd=1,xlim=x.lim,ylim=y.lim,pch=15, xlab="Risk score",ylab="Predicted 5-year risk (%)")
points(points.range,p.MSM*100,type="b",lwd=1,xlim=x.lim,ylim=y.lim,pch=16)
legend(x=0,y=100,legend=c("Recurrence","Melanoma-specific mortality"),pch=c(15,16),cex=.9,bg='white')
grDevices::dev.off()
```

```{r, eval=TRUE, echo=FALSE}
par(mar = c(5,5,2,5))
plot(h.plot,freq=FALSE,axes=FALSE, xlab=NA, xlim=x.lim, ylab=NA,ylim=y.lim.hist,main=NA,col='white')
abline(h=(0:30)*1,col="light grey",lty=2)
axis(side = 4)
mtext(side = 4, line = 3, 'Risk score distribution (%)')
par(new = TRUE)
plot(h.plot,freq=FALSE,axes=FALSE, xlab=NA, xlim=x.lim, ylab=NA,ylim=y.lim.hist,main=NA,col="white")

par(new = TRUE)
plot(points.range,p.Rec*100,type="b",lwd=1,xlim=x.lim,ylim=y.lim,pch=15, xlab="Risk score",ylab="Predicted 5-year risk (%)")
points(points.range,p.MSM*100,type="b",lwd=1,xlim=x.lim,ylim=y.lim,pch=16)
legend(x=0,y=100,legend=c("Recurrence","Melanoma-specific mortality"),pch=c(15,16),cex=.9,bg='white')
```

```{r, eval=TRUE}
# reset margins
par(mar = c(5,5,2,5))

# table of risk distribution
cbind(points.range, round(p.Rec*100, 1), round(p.MSM*100, 1))[c(1, 9, 10, 12, 13),]

# save for Rshiny app
coef.Rec <- stats::coef(f.mi.BS.Rec)
center.Rec <- f.mi.BS.Rec$center
save(h0.Rec, h0.MSM, coef.Rec, c.Breslow, center.Rec,
     file=paste0('Z:/Project Melanoom/PaperMelanoma/Results/h0.Rec.MSM.Rdata'), compress=TRUE)
load(file=paste0('Z:/Project Melanoom/PaperMelanoma/Results/h0.Rec.MSM.Rdata'))
```

# Test if model is correct
### Check calibration
```{r, eval=TRUE}
# Slope and intercept of recurrence and MSM
int.Rec
# check that int is same as this:
log(20)*f.mi.BS.Rec$coef["Age.SN"]+log(0.1)*f.mi.BS.Rec$coef["Breslow"]+log(0.01)*f.mi.BS.Rec$coef["Rdamcrit"]-f.mi.BS.Rec$center
```

### Check mean event rates of risk distribution
```{r, eval=TRUE}
# Recurrence
sum(h.Rec$density*fun.event(lp=lp.points.Rec, h0=h0.Rec))
# equal to the 5-year survival probability, kaplanmeier op 5 jaar, survfit op 5 jaar
SF<-survfit(S.Rec~1,data=sel.data)
100*(1-SF$surv[SF$time==max(SF$time[SF$time<=horizon])])
mean(fun.event(lp=lp.score.Rec, h0=h0.Rec))

# MSM
sum(h.Rec$density*fun.event(lp=lp.points.MSM, h0=h0.MSM))
SF<-survfit(S.MSM~1,data=sel.data)
100*(1-SF$surv[SF$time==max(SF$time[SF$time<=horizon])])
mean(fun.event(lp=lp.MSM, h0=h0.MSM))
```

### Example to check probabilities with app
```{r, eval=TRUE}
patient.nr <- 115 # 395 and 396 = Negative, 397 and 398 = Positive, 30 = Head & neck, 115 has large Breslow
data.to.be.imputed[patient.nr, c("SNstatus", "Age.SN", "Ulceration", "Loc_CAT", "Breslow", "Rdamcrit")]
lp.score.Rec.true <- predict(f.mi.BS.Rec)[patient.nr]
lp.score.Rec.try <- predict(f.mi.BS.Rec, newdata=data.frame(SNstatus=data.to.be.imputed[patient.nr,"SNstatus"],
                                                            Age.SN=data.to.be.imputed[patient.nr,"Age.SN"],
                                                            Ulceration=data.to.be.imputed[patient.nr,"Ulceration"],
                                                            Loc_CAT=data.to.be.imputed[patient.nr,"Loc_CAT"],
                                                            Breslow=data.to.be.imputed[patient.nr,"Breslow"],
                                                            Rdamcrit=data.to.be.imputed[patient.nr,"Rdamcrit"]),
                                                            type="lp")
p.Rec.example <- fun.event(lp=lp.score.Rec.try, h0=h0.Rec)
p.MSM.example <- fun.event(lp=lp.score.Rec.try, h0=h0.MSM)

# score
round((lp.score.Rec.try-int.Rec)/rc.Rec,0)

# manual calculation
coef.Rec <- stats::coef(f.mi.BS.Rec)
lp.manual <- coef.Rec["SNstatus=Positive"]*(as.numeric(data.to.be.imputed[patient.nr,"SNstatus"])-1)+
              coef.Rec["Age.SN"]*log(data.to.be.imputed[patient.nr,"Age.SN"])+
              coef.Rec["Ulceration=Yes"]*(as.numeric(data.to.be.imputed[patient.nr,"Ulceration"])-1)+
              coef.Rec["Loc_CAT=leg"]*as.numeric(data.to.be.imputed[patient.nr,"Loc_CAT"]=="leg")+
              coef.Rec["Loc_CAT=trunk"]*as.numeric(data.to.be.imputed[patient.nr,"Loc_CAT"]=="trunk")+
              coef.Rec["Loc_CAT=head & neck"]*as.numeric(data.to.be.imputed[patient.nr,"Loc_CAT"]=="head & neck")+
              coef.Rec["Breslow"]*(log(data.to.be.imputed[patient.nr,"Breslow"])-c.Breslow)+
              coef.Rec["Rdamcrit"]*log(data.to.be.imputed[patient.nr,"Rdamcrit"])+
              coef.Rec["SNstatus=Positive * Breslow"]*(log(data.to.be.imputed[patient.nr,"Breslow"])-c.Breslow)*(as.numeric(data.to.be.imputed[patient.nr,"SNstatus"])-1)
center.Rec <- f.mi.BS.Rec$center

# lp
lp.score.Rec.true
lp.score.Rec.try
lp.manual-center.Rec

# probability of recurrence
fun.event(lp=lp.score.Rec.try, h0=h0.Rec)
1-exp(-h0.Rec*exp(lp.manual-center.Rec))

# check MSM
lp.score.MSM.true <- predict(f.mi.BS.MSM)[patient.nr]
lp.score.MSM.true
lp.MSM.try <- MSM.cal.fact*(lp.manual-center.Rec)
lp.MSM.try
fun.event(lp=lp.MSM.try, h0=h0.MSM)
fun.event(lp=lp.MSM.try, h0=h0.MSM)
1-exp(-h0.MSM*exp(MSM.cal.fact*(lp.manual-center.Rec)))
```

### Test with old tool predictions recurrence for negative SN status patients
```{r, eval=TRUE}
rscript.negative <- function(breslow, ulceration, location) {
  S0 <- 0.85837329
  lp <- 0.79351989*log(breslow) +
    0.61912477*I(ulceration == 1) +
    0.29594843*I(location == 1) +
    0.42802046*I(location == 2) +
    0.86053044*I(location == 3) - 0.98860941
  S <- 100 - 100*S0^exp(lp)
  return(S)
}
old.negativeSN.tool <- rscript.negative(breslow=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Breslow"],
        ulceration=as.numeric(last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Ulceration"])-1,
        location=as.numeric(last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Loc_CAT"])-1)
lp.negative <- predict(f.mi.BS.Rec, newdata=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative",], type="lp")
new.negativeSN.tool <- 1-exp(-h0.Rec*exp(lp.negative))
plot(x=fun.event(lp=new.negativeSN.tool, h0=h0.Rec)*100, y=old.negativeSN.tool,
     xlim=c(0, 100), ylim=c(0, 100),
     xlab="New predictions", ylab="Old predictions",
     main="Predicted recurrence of patients with negative SN status")
abline(a=0, b=1, col="red")
```


### Test with old tool predictions recurrence for positive SN status patients
```{r, eval=TRUE}
rscript.positive <- function(age, ulceration, tumor_burden, breslow) {
  S0 <- 0.51762362
  lp <- 0.56109945 * log(age) +
    0.23383770 * log(tumor_burden) +
    0.35489235 * log(breslow) +
    0.36562098 * I(ulceration == 1) - 2.709225
  S <- 100 - 100 * S0^exp(lp)
  return(S)
}
old.positiveSN.tool <- rscript.positive(age=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Age.SN"],
                               ulceration=as.numeric(last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Ulceration"])-1,
                               breslow=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Breslow"],
                               tumor_burden=as.numeric(last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Rdamcrit"]))
lp.positive <- predict(f.mi.BS.Rec, newdata=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive",], type="lp")
new.positiveSN.tool <- 1-exp(-h0.Rec*exp(lp.positive))
plot(x=fun.event(lp=new.positiveSN.tool, h0=h0.Rec)*100, y=old.positiveSN.tool,
     xlim=c(0, 100), ylim=c(0, 100),
     xlab="New predictions", ylab="Old predictions",
     main="Predicted recurrence of patients with positive SN status")
abline(a=0, b=1, col="red")
```

### Histogram for negative SN status patients
```{r, eval=TRUE}
Breslow.trunc.neg <- last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Breslow"]
Breslow.trunc.neg[last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Breslow"]<0.1] <- .1
Breslow.trunc.neg[last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Breslow"]>7] <- 7
lp.score.Rec.negative <- predict(f.mi.BS.Rec,newdata=data.frame(SNstatus=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "SNstatus"],
                                                       Age.SN=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Age.SN"],
                                                       Ulceration=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Ulceration"],
                                                       Loc_CAT=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Loc_CAT"],
                                                       Breslow=Breslow.trunc.neg,
                                                       Rdamcrit=last.imputed.data.set[last.imputed.data.set$SNstatus=="Negative", "Rdamcrit"]))
mean(lp.score.Rec.negative)
# OK to use int.Rec and rc.Rec based on all patients?
score.Rec.neg <- round((lp.score.Rec.negative-int.Rec)/rc.Rec,0)
h.Rec.neg <- hist(score.Rec.neg,plot=FALSE,breaks=0:max.breaks,right=FALSE)
h.plot.neg <- h.Rec.neg
h.plot.neg$density <- 100*h.Rec.neg$density
```

### Histogram for positive SN status patients
```{r, eval=TRUE}
Breslow.trunc.pos <- last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Breslow"]
Breslow.trunc.pos[last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Breslow"]<0.1] <- .1
Breslow.trunc.pos[last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Breslow"]>7] <- 7
lp.score.Rec.positive <- predict(f.mi.BS.Rec,newdata=data.frame(SNstatus=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "SNstatus"],
                                                                Age.SN=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Age.SN"],
                                                                Ulceration=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Ulceration"],
                                                                Loc_CAT=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Loc_CAT"],
                                                                Breslow=Breslow.trunc.pos,
                                                                Rdamcrit=last.imputed.data.set[last.imputed.data.set$SNstatus=="Positive", "Rdamcrit"]))
mean(lp.score.Rec.positive)
# OK to use int.Rec and rc.Rec based on all patients?
score.Rec.pos <- round((lp.score.Rec.positive-int.Rec)/rc.Rec,0)
h.Rec.pos <- hist(score.Rec.pos,plot=FALSE,breaks=0:max.breaks,right=FALSE)
h.plot.pos <- h.Rec.pos
h.plot.pos$density <- 100*h.Rec.pos$density

par(mfrow=c(1, 3))
plot(h.plot,freq=FALSE,axes=TRUE, xlab="Risk score", xlim=x.lim,ylim=y.lim.hist,
     ylab="Risk score distribution (%)", main="All patients",col="white")
plot(h.plot.neg,freq=FALSE,axes=TRUE, xlab="Risk score", xlim=x.lim,
     ylab="Risk score distribution (%)",ylim=y.lim.hist,main="Negative SN status",col="white")
plot(h.plot.pos,freq=FALSE,axes=TRUE, xlab="Risk score", xlim=x.lim,
     ylab="Risk score distribution (%)",ylim=y.lim.hist,main="Positive SN status",col="white")
```

### Test proportional hazards assumption
```{r, eval=TRUE}
test.prop<-survival::cox.zph(f.mi.full.Rec$fits[[1]])
test.prop
plot(test.prop)
```
